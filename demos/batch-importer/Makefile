COMPOSE  := docker compose -f ../docker-compose.yml
KEYSPACE := cargo

.PHONY: db-up db-down seed seed-csv clean test

db-up:                          ## Start ScyllaDB and create keyspace
	@echo ""
	@echo "  ðŸ“¦ THE DIMENSIONAL CARGO DROP â€” Dimension-7"
	@echo "  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "  LoadMaster is booting up..."
	@echo ""
	$(COMPOSE) up -d
	@echo "  ðŸŒ€ Waiting for ScyllaDB node to materialize in this dimension..."
	@until $(COMPOSE) exec scylladb nodetool status 2>/dev/null | grep -q "^UN"; do sleep 2; done
	@echo "  âœ“ ScyllaDB is UP â€” cargo network established"
	@echo "  ðŸ”§ Creating keyspace '$(KEYSPACE)' across all timelines..."
	$(COMPOSE) exec scylladb cqlsh -e \
	  "CREATE KEYSPACE IF NOT EXISTS $(KEYSPACE) \
	   WITH replication = {'class': 'SimpleStrategy', 'replication_factor': '1'};"
	@echo "  âœ“ Keyspace ready â€” LoadMaster's warehouse is online"
	@echo ""

db-down:                        ## Stop ScyllaDB
	@echo "  ðŸŒ€ Shutting down cargo network... disconnecting ScyllaDB"
	$(COMPOSE) down
	@echo "  âœ“ LoadMaster has been disconnected"

seed: db-up                     ## Run batch import (depends on db-up)
	@echo "  ðŸ“¦ Deploying counter-manifest against LoadMaster..."
	@echo ""
	uv run python seed.py --count 200

seed-csv: db-up                 ## Import the bundled sample_manifest.csv (100 entries)
	@echo "  ðŸ“‚ Importing sample_manifest.csv..."
	@echo ""
	uv run python seed.py --feed sample_manifest.csv

clean: db-down                  ## Stop DB and remove data volumes
	$(COMPOSE) down -v
	@echo "  âœ“ All cargo data purged â€” dimensional rift sealed"

test:                           ## Run smoke test (requires ScyllaDB running)
	uv run python smoke_test.py
