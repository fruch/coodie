name: Self-Healing CI

# NOTE: workflow_run triggers only fire for workflow files that exist on the
# default branch. This workflow must be merged to main before it will react
# to failures in other workflows.
#
# GH_PAT secret â€” required for @copilot mentions to work on Copilot-authored PRs
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# The "Comment on pull request" step uses secrets.GH_PAT so the comment appears
# to come from a real user account.  Copilot ignores @copilot mentions that are
# posted by the GitHub Actions bot (GITHUB_TOKEN) on PRs it authored.
#
# Create a fine-grained Personal Access Token with the following settings:
#   URL:          https://github.com/settings/personal-access-tokens/new
#   Resource owner: fruch (or the org that owns this repo)
#   Repository access: Only select repositories â†’ fruch/coodie
#   Repository permissions:
#     â€¢ Pull requests: Read and write   â† needed to post PR comments
#
# Store the generated token as a repository secret named GH_PAT:
#   https://github.com/fruch/coodie/settings/secrets/actions/new

on:
  workflow_run:
    workflows:
      - CI
      - Unit Tests
      - Integration Tests
    types:
      - completed
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Workflow run ID to inspect'
        required: true
        type: number

jobs:
  on-failure:
    runs-on: ubuntu-latest
    if: >-
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'failure'
    permissions:
      contents: read
      pull-requests: write
      actions: read
      models: read
    steps:
      - uses: actions/checkout@v4

      - name: Find associated pull request
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          head_branch="${{ github.event.workflow_run.head_branch }}"

          # Try to find an open PR for the branch that triggered the failed run
          pr_number=$(gh pr list \
            --repo "${{ github.repository }}" \
            --head "${head_branch}" \
            --state open \
            --json number \
            --jq '.[0].number // empty')

          if [ -n "$pr_number" ]; then
            echo "found=true" >> "$GITHUB_OUTPUT"
            echo "number=${pr_number}" >> "$GITHUB_OUTPUT"
          else
            echo "found=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Collect failed job logs
        if: steps.pr.outputs.found == 'true'
        id: logs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          run_id=${{ github.event.workflow_run.id }}
          workflow_name="${{ github.event.workflow_run.name }}"
          run_url="${{ github.event.workflow_run.html_url }}"
          head_sha="${{ github.event.workflow_run.head_sha }}"

          # Collect logs from all failed jobs
          export REPO="${{ github.repository }}"
          export RUN_ID="${run_id}"
          source .github/scripts/collect-failed-logs.sh
          failed_logs="$FAILED_LOGS"

          # Write outputs
          {
            echo "workflow_name=${workflow_name}"
            echo "run_url=${run_url}"
            echo "head_sha=${head_sha}"
          } >> "$GITHUB_OUTPUT"

          # Store logs in a file (too large for output variable)
          echo "${failed_logs}" > /tmp/failed_logs.txt

      - name: Summarize failure with Copilot
        if: steps.pr.outputs.found == 'true'
        id: copilot_summary
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 .github/scripts/summarize-failure.py \
            --logs-file /tmp/failed_logs.txt \
            --output-file /tmp/copilot_summary.txt

      - name: Comment on pull request
        if: steps.pr.outputs.found == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
        run: |
          pr_number="${{ steps.pr.outputs.number }}"
          workflow_name="${{ steps.logs.outputs.workflow_name }}"
          run_url="${{ steps.logs.outputs.run_url }}"
          head_sha="${{ steps.logs.outputs.head_sha }}"
          failed_logs=$(cat /tmp/failed_logs.txt)
          copilot_summary=$(cat /tmp/copilot_summary.txt)

          cat > /tmp/comment.md <<EOF
          ## CI Failure: ${workflow_name}

          **Commit:** \`${head_sha}\`
          **Run:** ${run_url}

          ### ðŸ¤– Copilot Failure Analysis
          ${copilot_summary}

          ---

          @copilot please investigate the failure and suggest a fix.

          ## Failed Job Logs
          ${failed_logs}
          EOF

          gh pr comment "${pr_number}" \
            --repo "${{ github.repository }}" \
            --body-file /tmp/comment.md
