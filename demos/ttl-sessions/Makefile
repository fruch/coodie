COMPOSE  := docker compose -f ../docker-compose.yml
KEYSPACE := ephemera

.PHONY: db-up db-down seed run clean test

db-up:                          ## Start ScyllaDB and create keyspace
	@echo ""
	@echo "  ğŸ‘» THE MEMORY VAULT â€” Dimension-4"
	@echo "  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "  EPHEMERA is initializing memory harvest..."
	@echo ""
	$(COMPOSE) up -d
	@echo "  ğŸŒ€ Waiting for ScyllaDB node to come online..."
	@until $(COMPOSE) exec scylladb nodetool status 2>/dev/null | grep -q "^UN"; do sleep 2; done
	@echo "  âœ“ ScyllaDB is UP â€” memory vault anchored"
	@echo "  ğŸ”§ Creating keyspace '$(KEYSPACE)' (ephemeral data store)..."
	$(COMPOSE) exec scylladb cqlsh -e \
	  "CREATE KEYSPACE IF NOT EXISTS $(KEYSPACE) \
	   WITH replication = {'class': 'SimpleStrategy', 'replication_factor': '1'};"
	@echo "  âœ“ Keyspace ready â€” TTL enforcement active"
	@echo ""

db-down:                        ## Stop ScyllaDB
	@echo "  ğŸŒ€ Collapsing memory vault... shutting down ScyllaDB"
	$(COMPOSE) down
	@echo "  âœ“ EPHEMERA has been disconnected"

seed: db-up                     ## Seed session tokens (default TTL: 300s)
	@echo "  ğŸ‘» Deploying memory harvest protocol..."
	@echo ""
	uv run python seed.py --count 20 --ttl 300

seed-short: db-up               ## Seed short-lived tokens (TTL: 30s) to watch them expire
	@echo "  ğŸ‘» Seeding volatile memories â€” they dissolve in 30 seconds..."
	@echo ""
	uv run python seed.py --count 10 --ttl 30

run: seed                       ## Install deps, seed, and start the app
	@echo ""
	@echo "  ğŸ‘» Launching The Memory Vault interface..."
	@echo "  ğŸ“¡ http://127.0.0.1:8000 â€” Dimension-4 portal active"
	@echo "  â³ Watch rows disappear as TTL expires (auto-refresh every 5s)"
	@echo ""
	uv run uvicorn main:app --reload

clean: db-down                  ## Stop DB and remove data volumes
	$(COMPOSE) down -v
	@echo "  âœ“ All ephemeral data purged â€” memory vault wiped"

test: db-up                     ## Run smoke tests (requires ScyllaDB running)
	@echo "  ğŸ§ª Running smoke tests..."
	uv run python smoke_test.py
	@echo "  âœ“ All smoke tests passed"
