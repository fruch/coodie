# NOTE: The `issue_comment` trigger runs the workflow from the **default branch**,
# not the PR branch. This workflow YAML must be merged to the default branch
# before it will respond to comments. This is a GitHub Actions platform
# constraint, not a bug.
#
# Slash-commands (via PR comment):
#   /rebase        — Rebase the PR branch onto the base branch
#   /squash        — Squash all PR commits into one with a Copilot-generated message
#   /rebase squash — Rebase first, then squash
#
# Manual testing (via Actions tab → "Run workflow"):
#   Provide the PR number and select the command to run.
#
# See docs/plans/pr-comment-rebase-squash-action.md for full design details.

name: PR Rebase & Squash

on:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull request number to operate on'
        required: true
        type: number
      command:
        description: 'Command to execute'
        required: true
        type: choice
        options:
          - rebase
          - squash
          - rebase squash

concurrency:
  group: pr-rebase-squash-${{ github.event.issue.number || inputs.pr_number }}
  cancel-in-progress: false

jobs:
  rebase-squash:
    name: Rebase / Squash
    runs-on: ubuntu-latest
    if: >-
      github.event_name == 'workflow_dispatch' ||
      (
        github.event.issue.pull_request &&
        (
          contains(github.event.comment.body, '/rebase') ||
          contains(github.event.comment.body, '/squash')
        )
      )
    permissions:
      contents: write
      pull-requests: write
      issues: write
      workflows: write

    steps:
      # ── 0. Normalize inputs across triggers ──────────────────
      - name: Normalize inputs
        id: ctx
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ACTOR_ID=$(gh api "users/${{ github.actor }}" --jq '.id')
            {
              echo "pr_number=${{ inputs.pr_number }}"
              echo "actor=${{ github.actor }}"
              echo "actor_id=$ACTOR_ID"
              echo "has_comment=false"
            } >> "$GITHUB_OUTPUT"
          else
            {
              echo "pr_number=${{ github.event.issue.number }}"
              echo "actor=${{ github.event.comment.user.login }}"
              echo "actor_id=${{ github.event.comment.user.id }}"
              echo "has_comment=true"
            } >> "$GITHUB_OUTPUT"
          fi

      # ── 1. Permission check ──────────────────────────────────
      - name: Check collaborator permission
        id: permission
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PERM=$(gh api "repos/${{ github.repository }}/collaborators/${{ steps.ctx.outputs.actor }}/permission" \
            --jq '.permission')
          if [[ "$PERM" != "admin" && "$PERM" != "write" && "$PERM" != "maintain" ]]; then
            echo "User ${{ steps.ctx.outputs.actor }} lacks write access (has: $PERM)"
            exit 1
          fi

      # ── 2. Acknowledge ───────────────────────────────────────
      - name: React to comment
        if: steps.ctx.outputs.has_comment == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api "repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions" \
            -f content='eyes' --silent

      # ── 3. Checkout PR ───────────────────────────────────────
      - name: Get PR metadata
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_JSON=$(gh api "repos/${{ github.repository }}/pulls/${{ steps.ctx.outputs.pr_number }}")
          {
            echo "head_ref=$(echo "$PR_JSON" | jq -r '.head.ref')"
            echo "head_sha=$(echo "$PR_JSON" | jq -r '.head.sha')"
            echo "base_ref=$(echo "$PR_JSON" | jq -r '.base.ref')"
            echo "state=$(echo "$PR_JSON" | jq -r '.state')"
          } >> "$GITHUB_OUTPUT"

      - name: Abort if PR is not open
        if: steps.pr.outputs.state != 'open'
        run: |
          echo "PR #${{ steps.ctx.outputs.pr_number }} is ${{ steps.pr.outputs.state }}, not open."
          exit 1

      - uses: actions/checkout@v6
        with:
          ref: ${{ steps.pr.outputs.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git identity
        run: |
          git config user.name "${{ steps.ctx.outputs.actor }}"
          git config user.email "${{ steps.ctx.outputs.actor_id }}+${{ steps.ctx.outputs.actor }}@users.noreply.github.com"

      # ── 4. Parse command ─────────────────────────────────────
      - name: Parse slash command
        id: cmd
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_COMMAND: ${{ inputs.command }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            COMMAND="$INPUT_COMMAND"
          else
            COMMAND="$COMMENT_BODY"
          fi
          export COMMAND
          source .github/scripts/parse-command.sh
          {
            echo "do_rebase=$DO_REBASE"
            echo "do_squash=$DO_SQUASH"
          } >> "$GITHUB_OUTPUT"

      # ── 5. Rebase ───────────────────────────────────────────
      - name: Rebase onto base branch
        id: rebase
        if: steps.cmd.outputs.do_rebase == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BASE="${{ steps.pr.outputs.base_ref }}"
          git fetch origin "$BASE"

          if git rebase "origin/$BASE"; then
            echo "status=clean" >> "$GITHUB_OUTPUT"
          else
            echo "status=conflict" >> "$GITHUB_OUTPUT"
          fi

      # ── 5b. Resolve conflicts with Copilot CLI ──────────────
      - name: Resolve conflicts with Copilot CLI
        id: resolve
        if: steps.rebase.outputs.status == 'conflict'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_PAT }}
        run: |
          npm install -g @github/copilot 2>/dev/null || true
          bash .github/scripts/resolve-conflicts.sh

      - name: Abort on rebase conflicts
        if: steps.rebase.outputs.status == 'conflict' && steps.resolve.outputs.status != 'clean'
        run: |
          git rebase --abort
          echo "Rebase failed: Copilot could not resolve all conflicts automatically. Please resolve manually." >> "$GITHUB_STEP_SUMMARY"
          exit 1

      - name: Push rebased branch
        if: steps.cmd.outputs.do_rebase == 'true'
        run: git push --force-with-lease

      # ── 6. Squash ───────────────────────────────────────────
      - name: Squash commits
        if: steps.cmd.outputs.do_squash == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_PAT }}
        run: |
          BASE="${{ steps.pr.outputs.base_ref }}"
          git fetch origin "$BASE"
          MERGE_BASE=$(git merge-base HEAD "origin/$BASE")

          COMMIT_COUNT=$(git rev-list --count "$MERGE_BASE..HEAD")
          if [ "$COMMIT_COUNT" -le 1 ]; then
            echo "Only $COMMIT_COUNT commit(s) — nothing to squash." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          # Collect context for Copilot
          PR_NUMBER="${{ steps.ctx.outputs.pr_number }}"
          LOG=$(git log --oneline "$MERGE_BASE..HEAD")
          STAT=$(git diff --stat "$MERGE_BASE..HEAD")

          # PR title is always the subject line (follows Conventional Commits)
          TITLE=$(gh api "repos/${{ github.repository }}/pulls/${PR_NUMBER}" --jq '.title') || true
          if [ -z "$TITLE" ]; then
            TITLE="chore: squash ${COMMIT_COUNT} commits"
          fi

          # Try Copilot CLI for a full commit body description.
          # Write to a temp file so stray CLI output cannot leak into the
          # commit message (only the file content is used downstream).
          COPILOT_OUTPUT_FILE=$(mktemp)
          npm install -g @github/copilot 2>/dev/null || true
          copilot -p \
            "Write ONLY a git commit body (no subject line) summarising these changes. \
             Output plain text only — no markdown fences, no code blocks, no tool \
             calls, no reasoning steps. Be concise. \
             Commits: $LOG --- Diff stat: $STAT" \
            > "$COPILOT_OUTPUT_FILE" 2>/dev/null || true

          # Clean and validate Copilot output, with PR body fallback
          PR_BODY=$(gh api "repos/${{ github.repository }}/pulls/${PR_NUMBER}" \
            --jq '.body // empty') || true
          export TITLE COPILOT_OUTPUT_FILE PR_BODY
          source .github/scripts/build-squash-message.sh
          rm -f "$COPILOT_OUTPUT_FILE"

          # Squash
          git reset --soft "$MERGE_BASE"
          git commit -m "$MESSAGE"
          git push --force-with-lease

          {
            echo "### Squashed $COMMIT_COUNT commits"
            echo ""
            echo '```'
            echo "$MESSAGE"
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

      # ── 7. Summary comment ──────────────────────────────────
      - name: Post summary comment
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          STATUS="${{ job.status }}"
          PR_NUMBER="${{ steps.ctx.outputs.pr_number }}"

          # Add reaction to original comment (only for issue_comment trigger)
          if [ "${{ steps.ctx.outputs.has_comment }}" = "true" ]; then
            REACTION="rocket"
            if [ "$STATUS" != "success" ]; then
              REACTION="confused"
            fi
            gh api "repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions" \
              -f content="$REACTION" --silent || true
          fi

          # Post summary
          if [ "$STATUS" = "success" ]; then
            BODY="✅ **Done!** Rebase/squash completed successfully. See the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details."
          else
            BODY="❌ **Failed.** The rebase/squash operation did not complete. See the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details."
          fi

          gh pr comment "$PR_NUMBER" --repo "${{ github.repository }}" --body "$BODY"
