name: Self-Healing CI

# NOTE: This workflow is called from CI / Unit Tests / Integration Tests /
# Benchmarks / Demo Apps on failure via workflow_call.  This avoids the
# approval requirement that workflow_run triggers impose for bot-initiated
# runs (e.g. copilot-swe-agent).
#
# GH_PAT secret â€” required for @copilot mentions to work on Copilot-authored PRs
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# The "Comment on pull request" step uses secrets.GH_PAT so the comment appears
# to come from a real user account.  Copilot ignores @copilot mentions that are
# posted by the GitHub Actions bot (GITHUB_TOKEN) on PRs it authored.
#
# Create a fine-grained Personal Access Token with the following settings:
#   URL:          https://github.com/settings/personal-access-tokens/new
#   Resource owner: fruch (or the org that owns this repo)
#   Repository access: Only select repositories â†’ fruch/coodie
#   Repository permissions:
#     â€¢ Pull requests: Read and write   â† needed to post PR comments
#
# Store the generated token as a repository secret named GH_PAT:
#   https://github.com/fruch/coodie/settings/secrets/actions/new

on:
  workflow_call:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Workflow run ID to inspect'
        required: true
        type: number

jobs:
  on-failure:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      actions: read
      models: read
    steps:
      - uses: actions/checkout@v6

      - name: Find associated pull request
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HEAD_REF: ${{ github.head_ref }}
          REF_NAME: ${{ github.ref_name }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            run_id="${{ inputs.run_id }}"
            head_branch=$(gh api "repos/${{ github.repository }}/actions/runs/${run_id}" --jq '.head_branch')
          else
            head_branch="${HEAD_REF:-$REF_NAME}"
          fi

          # Try to find an open PR for the branch that triggered the failed run
          pr_number=$(gh pr list \
            --repo "${{ github.repository }}" \
            --head "${head_branch}" \
            --state open \
            --json number \
            --jq '.[0].number // empty')

          if [ -n "$pr_number" ]; then
            echo "found=true" >> "$GITHUB_OUTPUT"
            echo "number=${pr_number}" >> "$GITHUB_OUTPUT"
          else
            echo "found=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Collect failed job logs
        if: steps.pr.outputs.found == 'true'
        id: logs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            run_id="${{ inputs.run_id }}"
            workflow_name=$(gh api "repos/${{ github.repository }}/actions/runs/${run_id}" --jq '.name')
            run_url=$(gh api "repos/${{ github.repository }}/actions/runs/${run_id}" --jq '.html_url')
            head_sha=$(gh api "repos/${{ github.repository }}/actions/runs/${run_id}" --jq '.head_sha')
          else
            run_id="${{ github.run_id }}"
            workflow_name="${{ github.workflow }}"
            run_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            head_sha="${{ github.sha }}"
          fi

          # Collect logs from all failed jobs
          export REPO="${{ github.repository }}"
          export RUN_ID="${run_id}"
          source .github/scripts/collect-failed-logs.sh
          failed_logs="$FAILED_LOGS"

          # Write outputs
          {
            echo "workflow_name=${workflow_name}"
            echo "run_url=${run_url}"
            echo "head_sha=${head_sha}"
          } >> "$GITHUB_OUTPUT"

          # Store logs in a file (too large for output variable)
          echo "${failed_logs}" > /tmp/failed_logs.txt

      - name: Summarize failure with Copilot
        if: steps.pr.outputs.found == 'true'
        id: copilot_summary
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 .github/scripts/summarize-failure.py \
            --logs-file /tmp/failed_logs.txt \
            --output-file /tmp/copilot_summary.txt

      - name: Comment on pull request
        if: steps.pr.outputs.found == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          pr_number="${{ steps.pr.outputs.number }}"
          workflow_name="${{ steps.logs.outputs.workflow_name }}"
          run_url="${{ steps.logs.outputs.run_url }}"
          head_sha="${{ steps.logs.outputs.head_sha }}"

          # Build comment from parts â€” avoid heredoc to prevent shell
          # expansion of $, backticks, etc. inside CI log content.
          {
            echo "## CI Failure: ${workflow_name}"
            echo ""
            echo "**Commit:** \`${head_sha}\`"
            echo "**Run:** ${run_url}"
            echo ""
            echo "### ðŸ¤– Copilot Failure Analysis"
            cat /tmp/copilot_summary.txt
            echo ""
            echo "---"
            echo ""
            echo "@copilot please investigate the failure and suggest a fix."
            echo ""
            echo "## Failed Job Logs"
            cat /tmp/failed_logs.txt
          } > /tmp/comment.md

          # Prefer GH_PAT (enables @copilot on bot PRs), fall back to GITHUB_TOKEN
          fallback_token="$GH_TOKEN"
          if [ -n "$GH_PAT" ]; then
            export GH_TOKEN="$GH_PAT"
          fi
          if ! gh pr comment "${pr_number}" \
               --repo "${{ github.repository }}" \
               --body-file /tmp/comment.md; then
            echo "::warning::GH_PAT failed, retrying with GITHUB_TOKEN"
            export GH_TOKEN="$fallback_token"
            gh pr comment "${pr_number}" \
              --repo "${{ github.repository }}" \
              --body-file /tmp/comment.md
          fi
